#!/usr/bin/env python3
import json
import sys
import subprocess
from pathlib import Path

# Model name mappings
MODEL_ALIASES = {
    "us-gov.anthropic.claude-sonnet-4-5-20250929-v1:0": "GOV Sonnet 4.5",
    "MiniMaxAI/MiniMax-M2": "GOV MiniMax-M2",
    "claude-opus-4-5-20251101": "Opus 4.5",
    "claude-sonnet-4-5-20250929": "Sonnet 4.5",
    "claude-haiku-4-5-20251001": "Haiku 4.5",
    # Add more mappings as needed
}


def get_git_stats(directory):
    """Get git branch and change stats for the given directory."""
    try:
        # Get current branch
        branch = subprocess.check_output(
            ["git", "-C", directory, "rev-parse", "--abbrev-ref", "HEAD"],
            stderr=subprocess.DEVNULL,
            text=True,
        ).strip()

        # Get stats for uncommitted changes
        diff_stats = subprocess.check_output(
            ["git", "-C", directory, "diff", "--numstat"],
            stderr=subprocess.DEVNULL,
            text=True,
        ).strip()

        # Get stats for staged changes
        staged_stats = subprocess.check_output(
            ["git", "-C", directory, "diff", "--cached", "--numstat"],
            stderr=subprocess.DEVNULL,
            text=True,
        ).strip()

        # Parse stats
        additions = deletions = 0
        for line in (diff_stats + "\n" + staged_stats).strip().split("\n"):
            if line:
                parts = line.split()
                if len(parts) >= 2 and parts[0] != "-" and parts[1] != "-":
                    try:
                        additions += int(parts[0])
                        deletions += int(parts[1])
                    except ValueError:
                        pass

        if additions > 0 or deletions > 0:
            return f"{branch} (+{additions},-{deletions})"
        return branch

    except subprocess.CalledProcessError:
        return None


def main():
    # Read JSON from stdin
    try:
        data = json.load(sys.stdin)
    except json.JSONDecodeError:
        print("Error: Invalid JSON input")
        return

    # Extract data from JSON
    model_id = data.get("model", {}).get("display_name", "Model Unknown")
    current_dir = data.get("workspace", {}).get("current_dir", "")
    context_window = data.get("context_window", {})

    # Apply model alias if available
    model_name = MODEL_ALIASES.get(model_id, model_id)

    # Get directory name
    directory_name = Path(current_dir).name if current_dir else "Path Unknown"

    # Get git info
    git_info = get_git_stats(current_dir) if current_dir else None

    # Get token usage
    window_size = context_window.get("context_window_size", 200000)
    used_percentage = context_window.get("used_percentage", 0) or 0
    tokens = round(window_size * used_percentage / 100.0, -2)
    token_info = f"{tokens / 1000:.1f}k"

    # Build status line
    parts = [model_name, directory_name]
    if git_info:
        parts.append(git_info)
    parts.append(token_info)

    print(" | ".join(parts))


if __name__ == "__main__":
    try:
        main()
    except Exception as exc:
        print(f"Error: {exc}")
